name: Pull Request

permissions:
  contents: read

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]


jobs:
  # Define the matrix of deltakit subprojects that were modified in the PR and should be
  # tested here. This is determined by looking at tags previously generated by
  # `label_pr.yml`.
  # Since there is no guarantee for `label_pr.yml` to run before this workflow,
  # this job returns all packages by default when no tags are set.
  define-project-matrix:
    runs-on: ubuntu-slim
    outputs:
      projects: ${{ steps.json_labels.outputs.projects }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
      - name: Label modified packages for testing.
        id: json_labels
        run: python tools/transform_labels.py
        env:
          projects: ${{ join(github.event.pull_request.labels.*.name, ',') }}

  # Build deltakit wheels.
  build-wheels:
    runs-on: ubuntu-slim
    needs: define-project-matrix
    strategy:
      matrix:
        projects: ${{ fromJSON(needs.define-project-matrix.outputs.projects) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Build deltakit subpackage ${{ matrix.projects.project }} wheel
        run: uv build --no-sources --package ${{ matrix.projects.project }}
      - name: Upload ${{ matrix.projects.project }} wheels artefacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.projects.project }}-wheel
          path: ./dist/*.whl
          retention-days: 7

  merge-upload-artefacts:
    needs: build-wheels
    runs-on: ubuntu-slim
    steps:
      - name: Merge uploaded artefacts
        uses: actions/upload-artifact/merge@v4
        with:
          name: all-deltakit-wheels
          pattern: deltakit*-wheel

  # Test the built wheels.
  tests-wheels:
    needs: [merge-upload-artefacts, define-project-matrix]
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
        dependency-resolution: ['highest', 'lowest-direct']
        projects: ${{ fromJSON(needs.define-project-matrix.outputs.projects) }}
    name: Test ${{ matrix.projects.project }} on ${{ matrix.python-version }} with ${{matrix.dependency-resolution}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: all-deltakit-wheels
          path: ./dist
      - name: Setup and sync venv for testing ${{ matrix.projects.project }}
        run: |
          uv sync --package ${{ matrix.projects.project }} --python ${{ matrix.python-version }} --resolution ${{matrix.dependency-resolution}} --group test --find-links ./dist/
          # "${_PROJECT//-/_}" is a bash string replacement operation.
          # See https://www.gnu.org/software/bash/manual/bash.html#Shell-Parameter-Expansion
          _PROJECT=${{ matrix.projects.project }} uv pip install ./dist/${_PROJECT/-/_}*.whl
      - name: Test ${{ matrix.projects.project }}
        run: uv run --python ${{ matrix.python-version }} --no-sync pytest
        working-directory: ./${{ matrix.projects.path }}

  # Perform static check on each deltakit project package.
  static-checks:
    runs-on: ubuntu-latest
    needs: define-project-matrix
    strategy:
      matrix:
        projects: ${{ fromJSON(needs.define-project-matrix.outputs.projects) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Setup venv
        run: uv sync --group=lint --group=security --package ${{ matrix.projects.project }}
      - name: Check for typos
        run: uv run typos
        working-directory: ./${{ matrix.projects.path }}
      - name: Run `ruff` syntax checker
        run: uv run ruff check
        working-directory: ./${{ matrix.projects.path }}
        if: ${{ always() }}
      - name: Run `ruff` formatting
        run: uv run ruff format --check
        working-directory: ./${{ matrix.projects.path }}
        if: ${{ always() }}
      - name: Run `mypy` type checker
        run: uv run mypy
        working-directory: ./${{ matrix.projects.path }}
        if: ${{ always() }}
      - name: Run `deptry` for dependency hygiene
        run: uv run deptry .
        working-directory: ./${{ matrix.projects.path }}
        if: ${{ always() }}
      - name: Run `bandit` for code vulnerabilities
        run: uv run bandit .
        working-directory: ./${{ matrix.projects.path }}
        if: ${{ always() }}
      - name: Run `ochrona` for dependency confusion and typos
        run: uv run ochrona pyproject.toml
        working-directory: ./${{ matrix.projects.path }}
        if: ${{ always() }}
      - name: Run `pip_audit` to check dependencies for known vulnerabilities
        # Ignore CVE-2025-53000 as it only affects `nbconvert` on Windows.
        # `nbconvert` is only used for documentation building on Linux.
        # Remove when https://github.com/jupyter/nbconvert/issues/2258 is fixed.
        run: uv run pip-audit --ignore-vuln CVE-2025-53000
        working-directory: ./${{ matrix.projects.path }}
        if: ${{ always() }}
